- name: AWX project sync 상태 대기
  vars:
    max_attempts: 10
    wait_seconds: 5
  block:
    - name: 초기화
      set_fact:
        sync_status: "pending"
        attempt: 0

    - name: 반복적으로 project sync 상태 확인
      until: sync_status in ['successful', 'failed']
      retries: "{{ max_attempts }}"
      delay: "{{ wait_seconds }}"
      register: project_status
      block:
        - name: 현재 최신 sync job 가져오기
          uri:
            url: "https://awx.example.com/api/v2/projects/{{ project_id }}/project_updates/?order_by=-id&page_size=1"
            method: GET
            user: "{{ awx_username }}"
            password: "{{ awx_password }}"
            force_basic_auth: true
            return_content: true
            status_code: 200
          register: project_update_raw

        - name: 최신 job 상태 추출
          set_fact:
            sync_status: "{{ (project_update_raw.json.results[0].status) | default('missing') }}"
